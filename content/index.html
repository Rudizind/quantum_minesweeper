<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Quantum Minesweeper</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="./client.css">
        <link rel="icon" href="./favicon/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
        <link rel="manifest" href="./favicon/site.webmanifest">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.0.1/mocha.min.js"></script>
        <script src="http://chaijs.com/chai.js"></script>
        <script src="./client.js"></script>
        <script src="./board.js"></script>
        <script src="./solver.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.0.1/mocha.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    </head>
    <body>
        <div class="container-fluid" style="height: 11%; background-color: rgb(38, 46, 83); color: white; margin-bottom: 2%;">
            <h1 style="margin-left: 5%;">Quantum Minesweeper</h1>
        </div>
        <div class="container-fluid align-middle" id="login" style="width: 80%; height: 20%; vertical-align: middle; text-align: center;">
            <div class="row">
                <div class="col-sm-2">
                    <p>Log in to play!</p>
                </div>
                <div class="col-sm-3">
                    <label>Username:</label>
                    <input id="usernameBox" type="text" placeholder="Enter username here...">
                </div>
                <div class="col-sm-3">
                    <label>Password:</label>
                    <input  id="passwordBox" type="password"  placeholder="Enter password here...">
                </div>
                <div class="col-sm-2">
                    <button id="regButt" class="btn" onclick="registerUser()">Register</button>
                </div>
                <div class="col-sm-2">
                    <button id="logButt" class="btn" onclick="loginUser()">Log in</button>
                </div>
            </div>
        </div>
        <div class="hidden" id="newgame" style="width: 80%; text-align: center;">
            <div class="row align-middle">
                <div class="col-sm-3"></div>
                <div class="col-sm-3" style="margin: auto;">
                    <p style="vertical-align: middle;">Start a new game of Quantum Minesweeper!</p>
                </div>
                <div class="col-sm-3" style="margin: auto;">
                    <button id="startGameButt" class="btn" onclick="startGame()">Start</button>
                </div>
                <div class="col-sm-3"></div>
            </div>
            <div class="row align-middle">
                <div class="col-sm-2"></div>
                <div class="col-sm-2" style="margin: auto;">
                    <p style="padding-top: 8.5px;">View your Stats!</p>
                </div>
                <div class="col-sm-2" style="margin: auto;">
                    <button id="viewStatsButt" class="btn" onclick="viewStats('single')">Stats</button>
                </div>
                <div class="col-sm-2" style="margin: auto;">
                    <p style="padding-top: 8.5px;">View the Leaderboard!</p>
                </div>
                <div class="col-sm-2" style="margin: auto;">
                    <button id="viewLeaderboardButt" class="btn" onclick="viewStats('all')">Leaderboard</button>
                </div>
                <div class="col-sm-2"></div>
            </div>
            <div class="row align-middle" style="padding-top: 5%;">
                <div class="col-sm-4"></div>
                <div class="col-sm-4" style="margin: auto;">
                    <h5>Game Options</h5>
                </div>
                <div class="col-sm-4"></div>
            </div>
            <div class="row align-middle">
                <div class="col-sm-4"></div>
                <div class="col-sm-2" style="margin: auto;">
                    <label>Board Size:</label>
                </div>
                <div class="col-sm-2" style="margin: auto;">
                    <select id="boardSizeChoice">
                        <option>Extra Small (5 x 5)</option>
                        <option>Small (8 x 7)</option>
                        <option>Medium (13 x 9)</option>
                        <option>Large (20 x 12)</option>
                        <option>Extra Large (30 x 16)</option>
                    </select>
                </div>
                <div class="col-sm-4"></div>
            </div>
            <div class="row align-middle">
                <div class="col-sm-4"></div>
                <div class="col-sm-2" style="margin: auto;">
                    <label>Number of Mines:</label>
                </div>
                <div class="col-sm-2" style="margin: auto;">
                    <select id ="mineChoice">
                        <option>Minimum (0.7x)</option>
                        <option>Normal (1.0x)</option>
                        <option>Maximum (1.3x)</option>
                    </select>
                </div>
                <div class="col-sm-4"></div>
            </div>
            <div class="row align-middle" style="padding-top: 5%; margin: auto;">
                <div class="col-sm-4"></div>
                <div class="col-sm-4" style="margin: auto;">
                    <h5>Additional Features</h5>
                </div>
                <div class="col-sm-4"></div>
            </div>
            <div class="row align-middle">
                <div class="col-sm-4"></div>
                <div class="col-sm-2" style="margin: auto;">
                    <label>Enable Mine Vision:</label>
                </div>
                <div class="col-sm-1" style="margin: auto;">
                    <input type="checkbox" id="mineVisionCheck"></input>
                </div>
                <div class="col-sm-1">
                    <div class="tooltipShow">?
                        <span class="tooltiptext">
                            Mine Vision lets you see the inner workings of Quantum Minesweeper. All mines are marked out
                            by their darker colour with this option, and when the quantum safety feature kicks in you get 
                            to see how the program has transformed the game board!
                        </span>
                    </div>
                </div>
                <div class="col-sm-4"></div>
            </div>
            <div class="row align-middle">
                <div class="col-sm-4"></div>
                <div class="col-sm-2">
                    <label>Enable Hints:</label>
                </div>
                <div class="col-sm-1">
                    <input type="checkbox" id="hintCheck"></input>
                </div>
                <div class="col-sm-1">
                    <div class="tooltipShow">?
                        <span class="tooltiptext">
                            Hints can help you out if you're stuck at a particular point in the game. When you use a hint, your 
                            chosen tile will receive one of these three border colors:</br>
                            - <span style="color: green;">Green:</span> Chosen tile is safe to click.
                                Definitely not a mine.</br>
                            - <span style="color: yellow;">Yellow:</span> Chosen tile is safe to click.
                                Might be a mine. Quantum safety will kick in.</br>
                            - <span style="color: red;">Red:</span> Chosen tile is NOT safe to click.
                                Definitely a mine. <strong>Will result in game loss</strong>.
                        </span>
                    </div>
                </div>
                <div class="col-sm-4"></div>
            </div>
            <div class="row align-middle" style="padding-top: 5%;">
                <div class="col-sm-4"></div>
                <div class="col-sm-4">
                    <button class="btn" onclick="showAboutInfo()">About Quantum Minesweeper</button>
                </div>
                <div class="col-sm-4"></div>
            </div>
        </div>
        <div class="hidden" id="aboutInfo">
            <div class="col-sm-2"></div>
            <div class="col-sm-8" style="margin: auto;">
                <h3>About Quantum Minesweeper</h3>
                <p id="aboutText">
                    /* PRINCIPLES OF QUANTUM MINESWEEPER */

                    Ever been playing Minesweeper and gotten frustrated that your game has come down to a pure guess? Often a game's conclusion comes down to luck - a 50/50 chance. If you're not familiar with the rules of Minesweeper, they can be found here: https://en.wikipedia.org/wiki/Minesweeper_(video_game).

                    This version of Minesweeper - 'Quantum Minesweeper' - aims to remove this frustration. Many versions of this game provide a 'safety' feature that ensures the user's first click cannot be a mine. Here, we extend this concept to every click of a tile in the game. That said, there are three possible course of action the game will take when a user chooses a square:

                    (1) When a user clicks on a tile containing a mine, if it is guaranteed to be a mine in the current board state (i.e. in every possible configuration of mine and non-mine squares around the current 'revealed' tiles, that tile contains a mine in 100% of cases), the user loses. 
                    (2) When the user clicks on a tile containing a mine, if it is not guaranteed to be a mine in the current board state (i.e. in every possible configuration of mine and non-mine squares around the current 'revealed' tiles, that tile contains a mine in somewhere between 0% and 100% of cases (exclusive)), then the quantum safety feature activates and will attempt to resolve the board in such a way that the chosen square is not a mine given current known and deducible information. See quantum safety/solver section below.
                    (3) When the user clicks on a tile NOT containing a mine, the square is revealed. If its 8 neighbours do not contain a mine (i.e. its mineCount number is 0), it performs a depth-first recursion over each square w and its children and so on until all appropriate squares have been revealed. This step is no different to standard Minesweeper.



                    /* QUANTUM SAFETY/SOLVER */

                    TL;DR: If a player clicks on a tile that contains a mine, if the solver determines that that tile does not *absolutely* contain a mine given current known and deducible information, then the game board will resolve in such a way that that tile is revealed and does NOT contain a mine.

                    Enter Quantum Minesweeper. When a player clicks on a mine, the solver checks if the player could have determined through other moves (or deduction directly for that tile) that their chosen tile contained a mine. It does this in several steps. Firstly, it solves whatever tiles it can on the board using two basic heuristics for Minesweeper until it can no longer do so. These heuristics are: (1) if a tile's number is equal to the number of flags currently placed in the 8 neighbours of that tile, then all remaining unknown neighbour tiles must be safe tiles, and can be marked as revealed; and (2) if a tile's number is equal to the number of flags currently placed in the 8 neighbours of that tile ADDED TO the number of unrevealed neighbours, then each of those unrevealed neighbours must all contain mines, and can be flagged. 

                    Using these two heuristics, simple game boards such as 5x5 with 5 mines can be solved relatively consistently. However, when we begin looking at larger game boards and mine counts, these heuristics prove insufficient by themselves. Once no more information can be found using these heuristics, therefore, the solver moves to the second step of its solution: the probability-based algorithm. This algorithm determines any information that a human could deduce by cleverly calculating possible configurations of mines in a given set of border tiles around a known are on the game board.

                    The solver recursively checks combinations of 'mine' and 'not-mine' in each border tile until it finds that the current combination doesn't work (which cuts off the search and continues with the next branch), or until the number of 'mine/not-mine' guesses passes the OK check and is equal to the number of unrevealed border tiles presented to it. It continues to do this to find as many combinations as possible of mines that feasibly could work in the current board state. Once it has concluded and has its list of combinations (a 2D array), it then checks each tile's guess within each of the possible combinations. It uses the logic that, if a tile has been guessed as a mine in every working combination, then it must contain a mine and can be flagged as such; similarly, if a tile has been guessed safe in every working combination, then it must be safe and can be made revealed. With this new information, the solver begins again using the heuristics mentioned above. This cycle continues until either part of the solver reaches the player's chosen tile and decides that it contains a mine, or until no more information can be deduced (meaning that the player could not have determined that their tile contained a mine).

                    When it comes to the player's chosen tile, if the solver has been called it means that there is some probability of that tile containing a mine (so there is no chance of it returning absolutely safe). The only way the solver will render any chosen tile as 'uncertain' is if it has no new information when it concludes the probability-based solver and stops. At this stage, the mines on the actual gameboard are reshuffled in one of two ways: (1) if the player's chosen tile has not been uncovered yet (i.e. it is not included in the last round of unrevealed border tiles by the solver), then its mine is removed and placed somewhere else on the board that is also unrevealed to the player at this stage; or (2) if the player's chosen tile IS included in the last round of unrevealed border tiles by the probability-based solver, and it hasn't been determined to absolutely contain a mine, then the program will make 'true' one of the possible configurations returned within its calculations. Specifically, it will make true a configuration of mines around those border tiles that renders the player's chosen tile as NOT containing a mine, therefore making their click safe. If this changing of border tiles results in a mine count less than or greater than the starting mine count, then the solver also looks for tiles undiscovered by the player and adds (or takes away) mines as appropriate.

                    Once the mines have been reshuffled according to the logic above, the game continues and the player can make another click on the game board.

                    /* SOLVER REPLAY */

                    So... you lost the game. Maybe you know how you lost, and that's cool. Sometimes, though, a player may find that they've lost the game but don't understand why - and that's why a solver replay feature has been implemented within the Quantum Minesweeper game.

                    When you lose a game of Quantum Minesweeper, the game is basically telling you - "you could've figured out that there was a mine here." The solver stores the actions it took to decide that your chosen tile contained a mine, and you can view them yourself when a game ends by clicking the "See the solver's actions" button at the bottom of the gameboard. This will give you a step-by-step walkthrough of each move taken by the solver, and the reason behind that decision. With this you can see how the solver cleared various (sometimes many!) tiles on the board in order to reach your chosen tile and decide that it contained a mine. The display includes a 'move counter' which displays the order and final quantity of tiles uncovered by the solver in its solution, as well as a brief description of why that tile contained a mine/was safe.
                </p>
            </div>
            <div class="col-sm-2"></div>
        </div>
        <div class="hidden" id="hotbar">
            <div class="row">
                <div class="col-sm-3"></div>
                <div class="col-sm-2" style="text-align: center;">
                    <p id="scoreDisplay">Mines left: 0</script></p>
                </div>
                <div class="col-sm-2" style="text-align: center;">
                    <p id="activeGame">Active Game</p>
                </div>
                <div class="col-sm-2" style="text-align: center;">
                    <p id="gameTimer">Time Elapsed: 0</p>
                </div>
                <div class="col-sm-3"></div>
            </div>
        </div>
        <div class="hidden" id="replayDisplay">
            <div class="row align-middle">
                <div class="col-sm-3"></div>
                <div class="col-sm-6">
                    <p id="replayText" style="text-align: center;">Game state before solver begins</p>
                </div>
                <div class="col-sm-3"></div>
            </div>
            <div class="row align-middle" style="padding-bottom: 1%;">
                <div class="col-sm-4"></div>
                <div class="col-sm-1" style="text-align: center;">
                    <button id="leftArrow" class="btn" onclick="" style="opacity:0.5;"><</button>
                </div>
                <div class="col-sm-2" style="text-align:center; align-items: center;">
                    <p id="tilesSolved" style="padding-top: 8px;">Tiles solved: 0</p>
                </div>
                <div class="col-sm-1" style="text-align: center;">
                    <button id="rightArrow" class="btn" onclick="solver.changeMove(1)">></button>
                </div>
                <div class="col-sm-4"></div>
            </div>
        </div>
        <div class="hidden" id="gameboard" style="text-align: center; margin-bottom: 1%;">
            <table id="boardTable">
                <!--Content of the table will be created & manipulated using client.js file-->
            </table>
        </div>
        <div class="hidden" id="statsDisplay" style="text-align: center; margin-bottom: 1%;">
            <h5 id="statsHeading"></h5>
            <table id="statsTable" style="width: 80%; border: 2px solid black; margin: auto;">
                <!--Content of the table will be created & manipulated using client.js file-->
            </table>
        </div>
        <div class="hidden" id="homeButt" style="text-align: center; height: 4%; margin-bottom: 1%;">
            <button class="btn" onclick="backHome()">Return to Menu</button>
            <button class="hidden" id="hintButt" onclick="toggleHint()">Use Hint</button>
            <button class="hidden" id="replayButt" onclick="showReplay()">See the solver's actions</button>
        </div>
    </body>
</html>